name: Performance Benchmark V2

on:
  workflow_dispatch: # run on request (no need for PR)
    inputs:
      num-repeat:
        description: Overrides default per-data-group number of repeat setting
        type: number
        default: 5
      num-epoch:
        description: Overrides default per-model number of epoch setting. If 0, use default from template.
        type: number
        default: 0
      eval-upto:
        type: choice
        description: The last operation to evaluate. 'optimize' means all.
        options:
          - train
          - export
          - optimize
        default: optimize
      data-root:
        type: string
        description: Root directory containing validation data in CI server.
        default: "/home/validation/data/v2/"
  workflow_call:
    inputs:
      num-repeat:
        type: number
        description: Overrides default per-data-group number of repeat setting
        default: 5
      num-epoch:
        type: number
        description: Overrides default per-model number of epoch setting. If 0, use default from template.
        default: 0
      eval-upto:
        type: string
        description: The last operation to evaluate. 'optimize' means all. [train, export, optimize]
        default: optimize
      data-root:
        type: string
        description: Root directory containing validation data in CI server.
        default: "/home/validation/data/v2/"

# Declare default permissions as read only.
permissions: read-all

jobs:
  Perf-Benchmark-Run:
    strategy:
      fail-fast: false
      matrix:
        include:
          - task: ANOMALY
          - task: DETECTION
          - task: MULTI_CLASS_CLS
          - task: MULTI_LABEL_CLS
          - task: H_LABEL_CLS
          # - task: INSTANCE_SEGMENTATION
          # - task: SEMANTIC_SEGMENTATION
          # - task: VISUAL_PROMPTING

    name: Perf-Benchmark-${{ matrix.task }}
    runs-on: [self-hosted, linux, x64, dmount-v2]
    timeout-minutes: 8640
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Install Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.10"
      - name: Install tox
        run: |
          python -m pip install --require-hashes --no-deps -r .ci/requirements.txt
          pip-compile --generate-hashes --output-file=/tmp/requirements.txt --extra=ci_tox pyproject.toml
          python -m pip install --require-hashes --no-deps -r /tmp/requirements.txt
          rm /tmp/requirements.txt
      - name: Run Performance Test
        env:
          BENCHMARK_RESULTS_CLEAR: ${{ vars.BENCHMARK_RESULTS_CLEAR }}
          GH_CTX_REF_NAME: ${{ github.ref_name }}
          GH_CTX_SHA: ${{ github.sha }}
        run: |
          rm -rf .tox
          export TASK="${{ matrix.task }}"
          export DATA_ROOT="${{ inputs.data-root }}"
          export NUM_REPEAT="${{ inputs.num-repeat }}"
          export NUM_EPOCH="${{ inputs.num-epoch }}"
          export EVAL_UPTO="${{ inputs.eval-upto }}"
          export GITHUB_ACTOR="${{ github.triggering_actor }}"
          export DEVICE="gpu"
          export SUMMARY_FILE_ROOT=".tox"
          tox -vv -e perf-benchmark-v2

      - name: Upload test results
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: benchmark-results-${{ matrix.task }}
          include-hidden-files: true
          path: ${{ github.workspace }}/.tox/${{ matrix.task }}-*.xlsx
