name: Pull Request Comment Triggered Integration Test

on:
  issue_comment:
    types: [created]

env:
  COMMENT_BODY: ${{ github.event.comment.body }}

permissions:
  issues: write

jobs:
  pr-triggered-integration-test:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/run ')
    runs-on: [self-hosted, linux, x64, dev, dmount]
    name: PR-Comment-Integration-Tests
    steps:
      - name: Post workflow run link in PR
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = context.payload.issue.pull_request.url;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ Workflow run started: [View run](${runUrl})`
            });

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install tox
        run: |
          python -m pip install --require-hashes --no-deps -r .ci/requirements.txt
          pip-compile --generate-hashes --output-file=/tmp/requirements.txt --extra=ci_tox pyproject.toml
          python -m pip install --require-hashes --no-deps -r /tmp/requirements.txt
          rm /tmp/requirements.txt

      - name: Extract, Validate, and Run Integration Test
        run: |
          ALLOWED_TASKS=("all detection" "instance_segmentation" "semantic_segmentation" "multi_class_cls" "multi_label_cls" "h_label_cls" "anomaly" "keypoint_detection")

          # Ensure comment starts with "/run " and extract task name
          if [[ "$COMMENT_BODY" =~ ^/run\ ([a-zA-Z0-9_-]+)$ ]]; then
            TASK_NAME="${BASH_REMATCH[1]}"
          else
            echo "‚ùå Invalid format. Use '/run <task_name>'"
            exit 1
          fi

          # Validate the extracted task name
          if [[ ! " ${ALLOWED_TASKS[@]} " =~ " ${TASK_NAME} " ]]; then
            echo "‚ùå Invalid task: $TASK_NAME. Allowed tasks: ${ALLOWED_TASKS[*]}"
            exit 1
          fi

          echo "‚úÖ Running integration test for: $TASK_NAME"
          tox -vv -e "integration-test-${TASK_NAME}"

      - name: Post result to PR
        uses: actions/github-script@v7
        with:
          script: |
            const conclusion = "${{ job.status }}";
            const message = conclusion === "success"
              ? "‚úÖ Workflow succeeded!"
              : conclusion === "failure"
                ? "‚ùå Workflow failed."
                : "‚ö†Ô∏è Workflow finished with status: " + conclusion;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
