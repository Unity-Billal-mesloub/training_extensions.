name: Pull Request Comment Triggered Integration Test

on:
  issue_comment:
    types: [created]

env:
  COMMENT_BODY: ${{ github.event.comment.body }}

permissions:
  pull-requests: write
  contents: read
  issues: read

jobs:
  pr-triggered-integration-test:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/run ')
    runs-on: [self-hosted, linux, x64, dev, dmount]
    name: PR-Comment-Integration-Tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install tox
        run: |
          python -m pip install --require-hashes --no-deps -r .ci/requirements.txt
          pip-compile --generate-hashes --output-file=/tmp/requirements.txt --extra=ci_tox pyproject.toml
          python -m pip install --require-hashes --no-deps -r /tmp/requirements.txt
          rm /tmp/requirements.txt

      - name: Extract, Validate, and Run Integration Test
        run: |
          ALLOWED_TASKS=("all" "detection" "instance_segmentation" "semantic_segmentation" "multi_class_cls" "multi_label_cls" "h_label_cls" "anomaly" "keypoint_detection")

          # Ensure comment starts with "/run " and extract task name
          if [[ "$COMMENT_BODY" =~ ^/run\ ([a-zA-Z0-9_-]+)$ ]]; then
            TASK_NAME="${BASH_REMATCH[1]}"
          else
            echo "‚ùå Invalid format. Use '/run <task_name>'"
            exit 1
          fi

          # Validate the extracted task name
          if [[ ! " ${ALLOWED_TASKS[@]} " =~ " ${TASK_NAME} " ]]; then
            echo "‚ùå Invalid task: $TASK_NAME. Allowed tasks: ${ALLOWED_TASKS[*]}"
            exit 1
          fi

          echo "‚úÖ Running integration test for: $TASK_NAME"
          tox -vv -e "integration-test-${TASK_NAME}" -- --run-category-only=False

      - name: Update PR description with workflow run link and result
        if: always() # Ensure this runs even if the job fails
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} # Or your PAT if needed
          script: |
            const status = '${{ steps.tests.outcome }}'; // success, failure, skipped
            const emoji = {
              success: "‚úÖ",
              failure: "‚ùå",
              skipped: "‚ö†Ô∏è",
            }[status] || "‚ùì";

            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const lastCommit = commits[commits.length - 1];
            const lastCommitMsg = lastCommit.commit.message.split('\n')[0];

            const tag = "<!-- INTEGRATION-RUN-LINK -->";
            const runSection = `${tag}

            ## üöÄ Integration Run Summary

            - **Last Commit:** ${lastCommitMsg}
            - **Result:** ${emoji} ${status.toUpperCase()}
            - **Workflow Run:** [View Run](${runUrl})
            `;

            const newBody = pr.body.includes(tag)
              ? pr.body.replace(new RegExp(`${tag}[\\s\\S]*?(\n|$)`), runSection)
              : `${pr.body}\n\n${runSection}`;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: newBody
            });
