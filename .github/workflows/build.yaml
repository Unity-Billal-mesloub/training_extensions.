name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - releases/**
    tags:
      - "v*"
  pull_request:
  merge_group:
    branches:
      - develop
      - releases/**

permissions: {} # No permissions by default on workflow level

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.after }}
  cancel-in-progress: true

jobs:
  # Determines if workflow should execute based on event type and changed paths
  # If push or workflow_dispatch -> always run
  # If PR or merge_group -> run only if files in specified paths changed
  check_paths:
    name: Check if workflow should run
    runs-on: ubuntu-latest
    outputs:
      run_workflow: ${{ steps.run_workflow.outputs.run }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Get all paths that should trigger the workflow
        id: changed-files-yaml
        uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c # v46.0.5
        with:
          files_yaml: |
            test:
              - ui/**
              - backend/**
              - docker/**
              - .github/**

      - name: Set run flag
        id: run_workflow
        run: |
          if [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.changed-files-yaml.outputs.test_any_changed }}" = "true" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build and upload docker image
    runs-on: ubuntu-latest
    needs: check_paths
    if: needs.check_paths.outputs.run_workflow == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@364cc21a5de5b1ee4a7f5f9d3fa374ce0ccde746 #v1.2.0

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 #v5.7.0
        with:
          tags: |
            type=sha
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build images
        working-directory: docker
        run: |
          # Build and tag images using provided metadata
          for TAG in $TAGS ; do
              TAG=${TAG} docker compose build

              docker save -o geti-tune-${TAG}.tar geti-tune:${TAG}
          done
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
          PUBLIC_API_BASE_URL: "/"

      - name: Run simple checks on the built image
        working-directory: docker
        run: |
          # Get the first tag for testing
          FIRST_TAG=$(echo "$TAGS" | awk 'NR==1 {print $1}')
          echo "Testing container with tag: $FIRST_TAG"

          # Start the container in detached mode
          CONTAINER_ID=$(docker run -d --rm -v .:/app/data -p 80:80 geti-tune:${FIRST_TAG})
          echo "Started container: $CONTAINER_ID"

          # Function to cleanup container on exit
          cleanup() {
              echo "Cleaning up container: $CONTAINER_ID"
              docker stop $CONTAINER_ID || true
          }
          trap cleanup EXIT

          TEST_URL="geti-tune.localhost"
          # Wait for container to be ready (max 60 seconds)
          echo "Waiting for container to be ready..."
          for i in {1..12}; do
              if curl -sf $TEST_URL/health > /dev/null 2>&1; then
                  echo "✅ Health check passed!"
                  break
              fi
              if [ $i -eq 12 ]; then
                  echo "❌ Health check failed after 60 seconds"
                  docker logs $CONTAINER_ID
                  exit 1
              fi
              echo "Attempt $i/12 - waiting 5 seconds..."
              sleep 5
          done

          EXPECTED_TITLE="Geti Tune"
          echo "Checking HTML title..."

          HTML_CONTENT=$(curl -sf $TEST_URL)
          if echo "$HTML_CONTENT" | grep -q "<title>.*$EXPECTED_TITLE.*</title>"; then
              echo "✅ HTML title check passed - found: $EXPECTED_TITLE"
          else
              echo "❌ HTML title check failed - expected title '$EXPECTED_TITLE' not found"
              echo "Actual HTML content:"
              echo "$HTML_CONTENT"
              exit 1
          fi

          echo "All checks passed successfully!"
        env:
          TAGS: ${{ steps.meta.outputs.tags }}

      - name: Get Docker image sizes
        working-directory: docker
        id: image-sizes
        if: github.event_name == 'pull_request'
        run: |
          echo "## Docker Image Sizes" > image_sizes.md
          echo "" >> image_sizes.md
          echo "| Image | Size |" >> image_sizes.md
          echo "|-------|------|" >> image_sizes.md

          for tar_file in geti-tune-*.tar; do
            if [ -f "$tar_file" ]; then
              size=$(ls -lh "$tar_file" | awk '{print $5}')
              image_name=$(basename "$tar_file" .tar)
              echo "| $image_name | $size |" >> image_sizes.md
            fi
          done

          echo "SIZES_CONTENT<<EOF" >> $GITHUB_OUTPUT
          cat image_sizes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with image sizes
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        if: |
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        env:
          SIZES_CONTENT: ${{ steps.image-sizes.outputs.SIZES_CONTENT }}
        with:
          script: |
            const comment = process.env.SIZES_CONTENT;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('## Docker Image Sizes')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload Docker images as artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #v4.6.2
        with:
          name: docker-images
          path: |
            docker/geti-tune-*.tar
          retention-days: 7

  required_check:
    name: Required Check build
    needs:
      - check_paths
      - build
    runs-on: ubuntu-latest
    env:
      CHECKS: ${{ join(needs.*.result, ' ') }}
    if: always() && !cancelled()
    steps:
      - name: Check jobs results
        run: |
          for check in ${CHECKS}; do
            echo "::notice::check=${check}"
            if [[ "$check" != "success" && "$check" != "skipped" ]]; then
              echo "::error ::Required status checks failed. They must succeed before this pull request can be merged."
              exit 1
            fi
          done
